version: '3'

tasks:
  build:
    summary: |
      Builds the testing Docker image
    cmds:
      - cp ../../bifrost/bifrost_listener/aggregation.py .
      - defer: rm aggregation.py
      - docker build . -t sofi_test:latest

  db:up:
    - docker-compose -f {{.CLI_ARGS}}/docker-compose.test-aggregation.yml up -d

  db:down:
    - docker-compose -f {{.CLI_ARGS}}/docker-compose.test-aggregation.yml down -v

  test:agg-pipeline:
    summary: |
      Runs the tests for the aggregation pipeline
    cmds:
      # We want build to run and complete before running tests
      - task: build
      - task: db:up
      - defer: { task: db:down }
      - docker run -it --rm --name python_unit_test --network bifrost_test_default sofi_test:latest AggregationPipelineTest.py

  test:agg-result:
    summary: |
      Runs the test for the aggregation result collection
    cmds:
      # We want build to run and complete before running tests
      - task: build
      - task: db:up
      - defer: { task: db:down }
      - docker run -it --rm --name python_unit_test --network bifrost_test_default sofi_test:latest AggregationResultTest.py

  test:utility:
    summary: |
      Runs test for utility functions
    cmds:
      # We want build to run and complete before running tests
      - task: build
      - docker run -it --rm --name python_unit_test sofi_test:latest BsonObjectComparisonTest.py

  default:
    summary: |
      Runs every test
    cmds:
      - task: test:agg-pipeline
      - task: test:agg-result
      - task: test:utility
    silent: true
