# https://taskfile.dev

version: '3'

vars:
  GREETING: Hello, World!

tasks:
  build:
    summary: |
      Builds the testing Docker image
    cmds:
      - cp ../../bifrost/bifrost_listener/aggregation.py .
      - defer: rm aggregation.py
      - cp -r ../../bifrost/bifrost_db/initdb.d/ ./initdb.d
      - defer: rm -rf ./initdb.d
      - docker build . -t sofi_test:latest
    sources:
      - ./*

  test-agg-pipeline:
    summary: |
      Runs the tests for the aggregation pipeline
    cmds:
        # We want build to run and complete before running tests
      - task: build
      - cmd: docker-compose up -d
      - defer: docker-compose down -v
      - docker run -it --rm --name python_unit_test --network bifrost_test_default sofi_test:latest AggregationPipelineTest.py

  test-agg-result:
    summary: |
      Runs the test for the aggregation result collection
    cmds:
      # We want build to run and complete before running tests
      - task: build
      - cmd: docker-compose up -d
      - defer: docker-compose down -v
      - docker run -it --rm --name python_unit_test --network bifrost_test_default sofi_test:latest AggregationResultTest.py

  test-utility:
    summary: |
      Runs test for utility functions
    cmds:
      # We want build to run and complete before running tests
      - task: build
      - docker run -it --rm --name python_unit_test sofi_test:latest BsonObjectComparisonTest.py

  default:
    summary: |
      Runs every test
    cmds:
      - task: test-agg-pipeline
      - task: test-agg-result
    silent: true
