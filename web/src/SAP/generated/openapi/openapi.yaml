openapi: 3.0.1
info:
  description: Sekvensanalyseplatform
  title: SAP
  version: 0.1.0
servers:
- url: http://localhost:8080/api/
security:
- jwt: []
tags:
- description: Operations about user
  name: user
- description: Operations for isolates
  name: analysis
paths:
  /analysis:
    get:
      description: Page through all the analysis in the system (WIP)
      operationId: get_analysis
      parameters:
      - description: opaque token to supply to get the next page of isolates
        explode: true
        in: query
        name: paging_token
        required: false
        schema:
          format: byte
          nullable: true
          type: string
        style: form
      - explode: true
        in: query
        name: page_size
        required: false
        schema:
          default: 100
          type: number
        style: form
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PageOfAnalysis'
          description: Page of isolates
      tags:
      - analysis
      x-openapi-router-controller: web.src.SAP.generated.controllers.analysis_controller
    post:
      description: Search all analysis by given query
      operationId: search_analysis
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AnalysisQuery'
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PageOfAnalysis'
          description: Page of isolates
      tags:
      - analysis
      x-openapi-router-controller: web.src.SAP.generated.controllers.analysis_controller
      x-codegen-request-body-name: query
  /analysis/changes:
    post:
      description: Submit a batch of analysis data changes
      operationId: submit_changes
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AnalysisChange'
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalysisChange'
          description: Changes accepted
      tags:
      - analysis
      x-openapi-router-controller: web.src.SAP.generated.controllers.analysis_controller
      x-codegen-request-body-name: body
  /analysis/columns:
    get:
      description: Get column metadata, scoped to authenticated user
      operationId: get_columns
      responses:
        "200":
          content:
            application/json:
              schema:
                items:
                  $ref: '#/components/schemas/Column'
                type: array
          description: Column collection
      tags:
      - analysis
      x-openapi-router-controller: web.src.SAP.generated.controllers.analysis_controller
  /approvals:
    get:
      description: Retrieve list of approvals for authenticated user
      operationId: get_approvals
      responses:
        "200":
          content:
            application/json:
              schema:
                items:
                  $ref: '#/components/schemas/Approval'
                type: array
          description: List of Approvals
      tags:
      - approval
      x-openapi-router-controller: web.src.SAP.generated.controllers.approval_controller
    post:
      description: Submit approval/rejection information
      operationId: create_approval
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApprovalRequest'
      responses:
        "201":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Approval'
          description: Approval accepted
      tags:
      - approval
      x-openapi-router-controller: web.src.SAP.generated.controllers.approval_controller
      x-codegen-request-body-name: body
  /approvals/matrix:
    get:
      description: Get the entire approval matrix for all analysis
      operationId: full_approval_matrix
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalMatrix'
          description: Approval matrix
      tags:
      - approval
      x-openapi-router-controller: web.src.SAP.generated.controllers.approval_controller
  /approvals/{approval_id}:
    delete:
      description: Cancel a pending approval
      operationId: cancel_approval
      parameters:
      - description: Id of approval to cancel
        explode: true
        in: path
        name: approval_id
        required: true
        schema:
          type: string
        style: simple
      responses:
        "204":
          description: Approval cancelled successfully.
      tags:
      - approval
      x-openapi-router-controller: web.src.SAP.generated.controllers.approval_controller
  /gdpr/extract:
    get:
      description: Extract all data given a personal identifier
      operationId: extract_data_from_pi
      parameters:
      - description: Identifier type
        explode: true
        in: query
        name: identifier_type
        required: true
        schema:
          $ref: '#/components/schemas/PersonalIdentifierType'
        style: form
      - description: Personal identifier number.
        explode: true
        in: query
        name: identifier
        required: true
        schema:
          type: string
        style: form
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PersonalData'
          description: OK
      tags:
      - gdpr
      x-openapi-router-controller: web.src.SAP.generated.controllers.gdpr_controller
  /me:
    get:
      description: Describe the current user and their permissions
      operationId: who_am_i
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserInfo'
          description: User info
      tags:
      - user
      x-openapi-router-controller: web.src.SAP.generated.controllers.user_controller
  /upload/bulk_metadata:
    post:
      description: Manually upload metadata for previously uploaded sequence files
      operationId: bulk_metadata
      requestBody:
        content:
          multipart/form-data:
            encoding:
              metadata_tsv:
                contentType: text/tsv
                style: form
            schema:
              $ref: '#/components/schemas/BulkUploadRequest'
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
          description: Isolate uploaded successfully. Reports errors.
      tags:
      - upload
      x-openapi-router-controller: web.src.SAP.generated.controllers.upload_controller
      x-codegen-request-body-name: query
  /upload/multi_upload:
    post:
      description: Manually upload multiple sequences with metadata
      operationId: multi_upload
      requestBody:
        content:
          multipart/form-data:
            encoding:
              metadata_tsv:
                contentType: text/tsv
                style: form
              files:
                contentType: application/gzip
                style: form
            schema:
              $ref: '#/components/schemas/MultiUploadRequest'
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
          description: Isolate uploaded successfully. Reports errors.
      tags:
      - upload
      x-openapi-router-controller: web.src.SAP.generated.controllers.upload_controller
      x-codegen-request-body-name: query
  /upload/single_upload:
    post:
      description: Manually upload isolate with metadata
      operationId: single_upload
      requestBody:
        content:
          multipart/form-data:
            encoding:
              metadata:
                contentType: application/json
                style: form
              file:
                contentType: application/gzip
                style: form
            schema:
              $ref: '#/components/schemas/SingleUploadRequest'
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
          description: Isolate uploaded successfully. Reports errors.
      tags:
      - upload
      x-openapi-router-controller: web.src.SAP.generated.controllers.upload_controller
      x-codegen-request-body-name: query
  /user/views:
    get:
      operationId: get_user_views
      responses:
        "200":
          content:
            application/json:
              schema:
                items:
                  $ref: '#/components/schemas/UserDefinedView'
                type: array
          description: Return user-defined view collection for the authenticated user
      tags:
      - user
      x-openapi-router-controller: web.src.SAP.generated.controllers.user_controller
    post:
      operationId: create_user_view
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserDefinedView'
      responses:
        "204":
          description: User-defined view created.
      tags:
      - user
      x-openapi-router-controller: web.src.SAP.generated.controllers.user_controller
  /user/views/{name}:
    delete:
      description: Delete an existing view
      operationId: delete_view
      parameters:
      - description: Name of view to delete
        explode: false
        in: path
        name: name
        required: true
        schema:
          type: string
        style: simple
      responses:
        "204":
          description: View deleted successfully.
      tags:
      - user
      x-openapi-router-controller: web.src.SAP.generated.controllers.user_controller
components:
  schemas:
    Organization:
      enum:
      - SSI
      - FVST
      - Other
      type: string
    PageOfAnalysis:
      example:
        paging_token: paging_token
        approval_matrix:
          key:
            key: approval_matrix
        total_count: 0
        items:
        - null
        - null
      properties:
        paging_token:
          nullable: true
          pattern: ^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$
          type: string
        total_count:
          type: integer
        items:
          items:
            $ref: '#/components/schemas/AnalysisResult'
          type: array
        approval_matrix:
          additionalProperties:
            additionalProperties:
              $ref: '#/components/schemas/ApprovalStatus'
            type: object
          type: object
      required:
      - approval_matrix
      - items
      - paging_token
      - total_count
    AnalysisQuery:
      example:
        paging_token: paging_token
        filters:
          key: filters
        page_size: 0
      properties:
        paging_token:
          description: opaque token to supply to get the next page of isolates
          format: byte
          nullable: true
          type: string
        page_size:
          default: 100
          nullable: true
          type: integer
        filters:
          additionalProperties:
            type: string
          type: object
    Column:
      example:
        pii: true
        approves_with:
        - approves_with
        - approves_with
        approvable: true
        editable: true
        organizations:
        - null
        - null
        field_name: field_name
      properties:
        approvable:
          type: boolean
        editable:
          type: boolean
        pii:
          type: boolean
        organizations:
          items:
            $ref: '#/components/schemas/Organization'
          type: array
        field_name:
          type: string
        approves_with:
          items:
            type: string
          type: array
    UserDefinedView:
      example:
        column_resizing:
          column_width: 0
          column_widths:
            key: '{}'
        hidden_columns:
        - hidden_columns
        - hidden_columns
        name: name
        sort_by:
        - id: id
          desc: true
        - id: id
          desc: true
        column_order:
        - column_order
        - column_order
      properties:
        name:
          type: string
        hidden_columns:
          items:
            type: string
          type: array
        column_resizing:
          $ref: '#/components/schemas/UserDefinedView_column_resizing'
        sort_by:
          items:
            $ref: '#/components/schemas/UserDefinedView_sort_by'
          type: array
        column_order:
          items:
            type: string
          type: array
      type: object
    ApprovalRequest:
      example:
        matrix:
          key:
            key: matrix
      properties:
        matrix:
          additionalProperties:
            additionalProperties:
              $ref: '#/components/schemas/ApprovalStatus'
            type: object
          type: object
      required:
      - matrix
      type: object
    Approval:
      allOf:
      - $ref: '#/components/schemas/ApprovalRequest'
      - $ref: '#/components/schemas/Approval_allOf'
    ApprovalStatus:
      enum:
      - pending
      - rejected
      - approved
      type: string
    ApprovalMatrix:
      additionalProperties:
        additionalProperties:
          $ref: '#/components/schemas/ApprovalStatus'
        type: object
      type: object
    AnalysisChange:
      additionalProperties:
        additionalProperties:
          type: string
        type: object
      type: object
    Resistance:
      enum:
      - Sensitiv
      - Resistent
      - Ukendt
      type: string
    BaseMetadata:
      properties:
        isolate_id:
          type: string
        sequence_id:
          type: string
        sequence_filename:
          type: string
        institution:
          $ref: '#/components/schemas/Organization'
        project_number:
          type: number
        project_title:
          type: string
        sampling_date:
          format: date-time
          type: string
        received_date:
          format: date-time
          type: string
        run_id:
          type: string
        public:
          type: string
        provided_species:
          type: string
        primary_isolate:
          type: boolean
      required:
      - institution
      - isolate_id
      - primary_isolate
      - provided_species
      - received_date
      - run_id
      - sequence_filename
      - sequence_id
    TbrSpecificMetadata:
      properties:
        cpr:
          pattern: ^(?:(?:31(?:0[13578]|1[02])|(?:30|29)(?:0[13-9]|1[0-2])|(?:0[1-9]|1[0-9]|2[0-8])(?:0[1-9]|1[0-2]))[0-9]{2}\s?-?\s?[0-9]|290200\s-?\s[4-9]|2902(?:(?!00)[02468][048]|[13579][26])\s?-?\s?[0-3])[0-9]{3}|000000\s?-?\s?0000$
          type: string
        gender:
          enum:
          - M
          - K
          type: string
        name:
          type: string
          x-faker: name.findName
        age:
          maximum: 128
          minimum: 0
          type: integer
        travel:
          type: string
        travel_country:
          type: string
          x-faker: address.country
        run_date:
          format: date-time
          type: string
        kma_received_date:
          format: date-time
          type: string
        kma:
          type: string
        region:
          type: string
        fud_number:
          type: string
        cluster_id:
          type: string
        epi_export:
          type: string
      required:
      - run_date
      type: object
    TbrMetadata:
      allOf:
      - $ref: '#/components/schemas/BaseMetadata'
      - $ref: '#/components/schemas/TbrSpecificMetadata'
    LimsSpecificMetadata:
      properties:
        chr_number:
          pattern: \d{5,6}
          type: string
        aut_number:
          type: string
        product_type:
          type: string
        product:
          type: string
        origin_country:
          type: string
          x-faker: address.country
        animal_species:
          type: string
        sample_info:
          type: string
      type: object
    LimsMetadata:
      allOf:
      - $ref: '#/components/schemas/BaseMetadata'
      - $ref: '#/components/schemas/LimsSpecificMetadata'
    AnalysisResult:
      allOf:
      - $ref: '#/components/schemas/BaseMetadata'
      - $ref: '#/components/schemas/LimsSpecificMetadata'
      - $ref: '#/components/schemas/TbrSpecificMetadata'
      - $ref: '#/components/schemas/AnalysisResult_allOf'
    SingleUploadRequest:
      properties:
        metadata:
          $ref: '#/components/schemas/BaseMetadata'
        file:
          format: binary
          type: string
      required:
      - file
      - metadata
      type: object
    MultiUploadRequest:
      properties:
        metadata_tsv:
          format: binary
          type: string
        files:
          items:
            format: binary
            type: string
          type: array
      required:
      - files
      - metadata_tsv
      type: object
    BulkUploadRequest:
      properties:
        metadata_tsv:
          format: binary
          type: string
      required:
      - metadata_tsv
      type: object
    UploadResponse:
      example:
        errors:
        - errors
        - errors
      properties:
        errors:
          items:
            type: string
          type: array
      type: object
    PersonalIdentifierType:
      enum:
      - CPR
      - CVR
      - CHR
      type: string
    PersonalData:
      example:
        data: data
      properties:
        data:
          type: string
      required:
      - data
      type: object
    DataClearance:
      enum:
      - own-institution
      - cross-institution
      - all
      type: string
    Permission:
      enum:
      - search
      - export
      - approve
      - phylogeny.read
      - phylogeny.write
      - gdpr.manage
      - permissions.write
      type: string
    UserInfo:
      example:
        permissions:
        - null
        - null
        groups:
        - groups
        - groups
        userId: userId
      properties:
        userId:
          type: string
        data_clearance:
          $ref: '#/components/schemas/DataClearance'
        institution:
          $ref: '#/components/schemas/Organization'
        groups:
          items:
            type: string
          type: array
        permissions:
          items:
            $ref: '#/components/schemas/Permission'
          type: array
      type: object
    UserDefinedView_column_resizing:
      example:
        column_width: 0
        column_widths:
          key: '{}'
      properties:
        column_widths:
          additionalProperties: true
          type: object
        column_width:
          type: integer
    UserDefinedView_sort_by:
      example:
        id: id
        desc: true
      properties:
        desc:
          type: boolean
        id:
          type: string
    Approval_allOf:
      properties:
        id:
          type: string
        approver:
          type: string
        timestamp:
          format: date-time
          type: string
        status:
          enum:
          - pending
          - cancelled
          - submitted
          type: string
    AnalysisResult_allOf:
      properties:
        _id:
          format: uuid
          type: string
        resfinder_version:
          pattern: ^([0-9]+)\.([0-9]+)\.([0-9]+)(?:-([0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*))?(?:\+[0-9A-Za-z-]+)?$
          type: string
        QC_provided_species:
          type: number
        QC_genome1x:
          type: number
        QC_genome10x:
          type: number
        QC_Gsize_diff1x10:
          type: number
        QC_Avg_coverage:
          type: number
        QC_final:
          enum:
          - A
          - B
          - C
          type: string
        subspecies:
          type: string
        species_final:
          type: string
        st:
          type: string
        pathotype:
          type: string
        pathotype_final:
          type: string
        serotype:
          type: string
        serotype_final:
          type: string
        adhesion:
          type: string
        adhesion_final:
          type: string
        toxins:
          type: string
        toxins_final:
          type: string
        infection_source:
          type: string
        resistance_genes:
          type: string
        amr_profile:
          type: string
        amr_ami:
          $ref: '#/components/schemas/Resistance'
        amr_amp:
          $ref: '#/components/schemas/Resistance'
        amr_azi:
          $ref: '#/components/schemas/Resistance'
        amr_fep:
          $ref: '#/components/schemas/Resistance'
        amr_fot:
          $ref: '#/components/schemas/Resistance'
        amr_f_c:
          $ref: '#/components/schemas/Resistance'
        amr_fox:
          $ref: '#/components/schemas/Resistance'
        amr_taz:
          $ref: '#/components/schemas/Resistance'
        amr_t_c:
          $ref: '#/components/schemas/Resistance'
        amr_chl:
          $ref: '#/components/schemas/Resistance'
        amr_cip:
          $ref: '#/components/schemas/Resistance'
        amr_cli:
          $ref: '#/components/schemas/Resistance'
        amr_col:
          $ref: '#/components/schemas/Resistance'
        amr_dap:
          $ref: '#/components/schemas/Resistance'
        amr_etp:
          $ref: '#/components/schemas/Resistance'
        amr_ery:
          $ref: '#/components/schemas/Resistance'
        amr_fus:
          $ref: '#/components/schemas/Resistance'
        amr_gen:
          $ref: '#/components/schemas/Resistance'
        amr_imi:
          $ref: '#/components/schemas/Resistance'
        amr_kan:
          $ref: '#/components/schemas/Resistance'
        amr_lzd:
          $ref: '#/components/schemas/Resistance'
        amr_mero:
          $ref: '#/components/schemas/Resistance'
        amr_mup:
          $ref: '#/components/schemas/Resistance'
        amr_nal:
          $ref: '#/components/schemas/Resistance'
        amr_pen:
          $ref: '#/components/schemas/Resistance'
        amr_syn:
          $ref: '#/components/schemas/Resistance'
        amr_rif:
          $ref: '#/components/schemas/Resistance'
        amr_str:
          $ref: '#/components/schemas/Resistance'
        amr_sul:
          $ref: '#/components/schemas/Resistance'
        amr_tei:
          $ref: '#/components/schemas/Resistance'
        amr_trm:
          $ref: '#/components/schemas/Resistance'
        amr_tet:
          $ref: '#/components/schemas/Resistance'
        amr_tia:
          $ref: '#/components/schemas/Resistance'
        amr_tgc:
          $ref: '#/components/schemas/Resistance'
        amr_tmp:
          $ref: '#/components/schemas/Resistance'
        amr_van:
          $ref: '#/components/schemas/Resistance'
      required:
      - _id
      - isolate_id
  securitySchemes:
    jwt:
      bearerFormat: JWT
      scheme: bearer
      type: http
      x-bearerInfoFunc: web.src.SAP.generated.controllers.security_controller_.info_from_jwt
