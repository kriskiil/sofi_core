openapi: 3.0.1
info:
  description: Sekvensanalyseplatform
  title: SAP
  version: 0.1.0
servers:
- url: http://localhost:8080/api/
security:
- jwt: []
tags:
- description: Operations about user
  name: user
- description: Operations for isolates
  name: analysis
paths:
  /analysis:
    get:
      description: Page through all the analysis in the system (WIP)
      operationId: get_analysis
      parameters:
      - description: opaque token to supply to get the next page of isolates
        explode: true
        in: query
        name: paging_token
        required: false
        schema:
          format: byte
          nullable: true
          type: string
        style: form
      - explode: true
        in: query
        name: page_size
        required: false
        schema:
          default: 100
          type: number
        style: form
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/page-of-analysis'
          description: Page of isolates
      tags:
      - analysis
      x-openapi-router-controller: web.src.SAP.generated.controllers.analysis_controller
    post:
      description: Search all analysis by given query
      operationId: search_analysis
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/analysis-query'
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/page-of-analysis'
          description: Page of isolates
      tags:
      - analysis
      x-openapi-router-controller: web.src.SAP.generated.controllers.analysis_controller
      x-codegen-request-body-name: query
  /analysis/changes:
    post:
      description: Submit a batch of analysis data changes
      operationId: submit_changes
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/analysis-change'
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/analysis-change'
          description: Changes accepted
      tags:
      - analysis
      x-openapi-router-controller: web.src.SAP.generated.controllers.analysis_controller
      x-codegen-request-body-name: body
  /analysis/columns:
    get:
      description: Get column metadata, scoped to authenticated user
      operationId: get_columns
      responses:
        "200":
          content:
            application/json:
              schema:
                items:
                  $ref: '#/components/schemas/column'
                type: array
          description: Column collection
      tags:
      - analysis
      x-openapi-router-controller: web.src.SAP.generated.controllers.analysis_controller
  /analysis/reload_metadata:
    post:
      description: Reload metadata for a given isolate
      operationId: reload_metadata
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/metadata-reload-request'
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/metadata-reload-response'
          description: Reload successful
      tags:
      - analysis
      x-openapi-router-controller: web.src.SAP.generated.controllers.analysis_controller
      x-codegen-request-body-name: body
  /approvals:
    get:
      description: Retrieve list of approvals for authenticated user
      operationId: get_approvals
      responses:
        "200":
          content:
            application/json:
              schema:
                items:
                  $ref: '#/components/schemas/approval'
                type: array
          description: List of Approvals
      tags:
      - approval
      x-openapi-router-controller: web.src.SAP.generated.controllers.approval_controller
    post:
      description: Submit approval/rejection information
      operationId: create_approval
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/approval-request'
      responses:
        "201":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/approval'
          description: Approval accepted
      tags:
      - approval
      x-openapi-router-controller: web.src.SAP.generated.controllers.approval_controller
      x-codegen-request-body-name: body
  /approvals/matrix:
    get:
      description: Get the entire approval matrix for all analysis
      operationId: full_approval_matrix
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/approval-matrix'
          description: Approval matrix
      tags:
      - approval
      x-openapi-router-controller: web.src.SAP.generated.controllers.approval_controller
  /approvals/{approval_id}:
    delete:
      description: Cancel a pending approval
      operationId: cancel_approval
      parameters:
      - description: Id of approval to cancel
        explode: true
        in: path
        name: approval_id
        required: true
        schema:
          type: string
        style: simple
      responses:
        "204":
          description: Approval cancelled successfully.
      tags:
      - approval
      x-openapi-router-controller: web.src.SAP.generated.controllers.approval_controller
  /gdpr/extract:
    get:
      description: Extract all data given a personal identifier
      operationId: extract_data_from_pi
      parameters:
      - description: Identifier type
        explode: true
        in: query
        name: identifier_type
        required: true
        schema:
          $ref: '#/components/schemas/personal-identifier-type'
        style: form
      - description: Personal identifier number.
        explode: true
        in: query
        name: identifier
        required: true
        schema:
          type: string
        style: form
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/personal-data'
          description: OK
      tags:
      - gdpr
      x-openapi-router-controller: web.src.SAP.generated.controllers.gdpr_controller
  /gdpr/forget:
    get:
      description: Forget about a person identifer, GDPR right to be forgotten
      operationId: forget_pii
      parameters:
      - description: Identifier type
        explode: true
        in: query
        name: identifier_type
        required: true
        schema:
          $ref: '#/components/schemas/personal-identifier-type'
        style: form
      - description: Personal identifier number.
        explode: true
        in: query
        name: identifier
        required: true
        schema:
          type: string
        style: form
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/personal-data'
          description: OK
      tags:
      - gdpr
      x-openapi-router-controller: web.src.SAP.generated.controllers.gdpr_controller
  /me:
    get:
      description: Describe the current user and their permissions
      operationId: who_am_i
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/user-info'
          description: User info
      tags:
      - user
      x-openapi-router-controller: web.src.SAP.generated.controllers.user_controller
  /upload/bulk_metadata:
    post:
      description: Manually upload metadata for previously uploaded sequence files
      operationId: bulk_metadata
      requestBody:
        content:
          multipart/form-data:
            encoding:
              path:
                contentType: text/plain
                style: form
              metadata_tsv:
                contentType: text/tsv
                style: form
            schema:
              $ref: '#/components/schemas/bulk-upload-request'
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/upload-response'
          description: Isolate uploaded successfully. Reports errors.
      tags:
      - upload
      x-openapi-router-controller: web.src.SAP.generated.controllers.upload_controller
      x-codegen-request-body-name: query
  /upload/multi_upload:
    post:
      description: Manually upload multiple sequences with metadata
      operationId: multi_upload
      requestBody:
        content:
          multipart/form-data:
            encoding:
              metadata_tsv:
                contentType: text/tsv
                style: form
              files:
                contentType: application/gzip
                style: form
            schema:
              $ref: '#/components/schemas/multi-upload-request'
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/upload-response'
          description: Isolate uploaded successfully. Reports errors.
      tags:
      - upload
      x-openapi-router-controller: web.src.SAP.generated.controllers.upload_controller
      x-codegen-request-body-name: query
  /upload/single_upload:
    post:
      description: Manually upload isolate with metadata
      operationId: single_upload
      requestBody:
        content:
          multipart/form-data:
            encoding:
              metadata:
                contentType: application/json
                style: form
              file:
                contentType: application/gzip
                style: form
            schema:
              $ref: '#/components/schemas/single-upload-request'
      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/upload-response'
          description: Isolate uploaded successfully. Reports errors.
      tags:
      - upload
      x-openapi-router-controller: web.src.SAP.generated.controllers.upload_controller
      x-codegen-request-body-name: query
  /user/views:
    get:
      operationId: get_user_views
      responses:
        "200":
          content:
            application/json:
              schema:
                items:
                  $ref: '#/components/schemas/user-defined-view'
                type: array
          description: Return user-defined view collection for the authenticated user
      tags:
      - user
      x-openapi-router-controller: web.src.SAP.generated.controllers.user_controller
    post:
      operationId: create_user_view
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/user-defined-view'
      responses:
        "204":
          description: User-defined view created.
      tags:
      - user
      x-openapi-router-controller: web.src.SAP.generated.controllers.user_controller
  /user/views/{name}:
    delete:
      description: Delete an existing view
      operationId: delete_view
      parameters:
      - description: Name of view to delete
        explode: false
        in: path
        name: name
        required: true
        schema:
          type: string
        style: simple
      responses:
        "204":
          description: View deleted successfully.
      tags:
      - user
      x-openapi-router-controller: web.src.SAP.generated.controllers.user_controller
components:
  schemas:
    user-info:
      example:
        permissions:
        - null
        - null
        groups:
        - groups
        - groups
        userId: userId
      properties:
        userId:
          type: string
        data_clearance:
          $ref: '#/components/schemas/data-clearance'
        institution:
          $ref: '#/components/schemas/organization'
        groups:
          items:
            type: string
          type: array
        permissions:
          items:
            $ref: '#/components/schemas/permission'
          type: array
      title: UserInfo
      type: object
    page-of-analysis:
      example:
        paging_token: paging_token
        approval_matrix:
          key:
            key: approval_matrix
        total_count: 0
        items:
        - null
        - null
      properties:
        paging_token:
          nullable: true
          type: string
        total_count:
          type: integer
        items:
          items:
            $ref: '#/components/schemas/analysis-result'
          type: array
        approval_matrix:
          additionalProperties:
            additionalProperties:
              $ref: '#/components/schemas/approval-status'
            type: object
          title: ApprovalMatrix
          type: object
      required:
      - approval_matrix
      - items
      - paging_token
      - total_count
      title: PageOfAnalysis
      type: object
    analysis-query:
      properties:
        paging_token:
          description: opaque token to supply to get the next page of isolates
          format: byte
          nullable: true
          type: string
        page_size:
          default: 100
          nullable: true
          type: integer
        filters:
          additionalProperties:
            type: string
          type: object
      title: AnalysisQuery
      type: object
    column:
      example:
        pii: true
        approves_with:
        - approves_with
        - approves_with
        approvable: true
        editable: true
        organizations:
        - null
        - null
        gdpr: true
        field_name: field_name
      properties:
        approvable:
          description: True if the column can be approved
          type: boolean
        editable:
          description: True if the column can be edited
          type: boolean
        pii:
          description: True if the column should be restricted to viewing only by
            the institution that owns it
          type: boolean
        gdpr:
          description: True if the column should be treated as a 'gdpr' column, subject
            to more strict auditing/logging
          type: boolean
        organizations:
          description: List of organizations/institutions who 'own' or should have
            unrestricted access to this field
          items:
            $ref: '#/components/schemas/organization'
          type: array
        field_name:
          type: string
        approves_with:
          description: List of other columns, if any, that should be sent along when
            this column gets approved
          items:
            type: string
          type: array
      title: Column
      type: object
    analysis-change:
      additionalProperties:
        additionalProperties:
          type: string
        type: object
      title: AnalysisChange
      type: object
    metadata-reload-request:
      properties:
        isolateId:
          type: string
        institution:
          $ref: '#/components/schemas/organization'
      required:
      - institution
      - isolateId
      title: MetadataReloadRequest
      type: object
    metadata-reload-response:
      discriminator:
        propertyName: institution
      oneOf:
      - $ref: '#/components/schemas/tbr-metadata'
      - $ref: '#/components/schemas/lims-metadata'
      title: MetadataReloadResponse
      type: object
    approval:
      allOf:
      - $ref: '#/components/schemas/approval-request'
      - $ref: '#/components/schemas/approval_allOf'
      title: Approval
      type: object
    approval-request:
      properties:
        matrix:
          additionalProperties:
            additionalProperties:
              $ref: '#/components/schemas/approval-status'
            type: object
          title: ApprovalMatrix
          type: object
      required:
      - matrix
      title: ApprovalRequest
      type: object
    approval-matrix:
      additionalProperties:
        additionalProperties:
          $ref: '#/components/schemas/approval-status'
        type: object
      title: ApprovalMatrix
      type: object
    user-defined-view:
      example:
        column_resizing:
          column_width: 0
          column_widths:
            key: '{}'
        hidden_columns:
        - hidden_columns
        - hidden_columns
        name: name
        sort_by:
        - id: id
          desc: true
        - id: id
          desc: true
        column_order:
        - column_order
        - column_order
      properties:
        name:
          type: string
        hidden_columns:
          items:
            type: string
          type: array
        column_resizing:
          $ref: '#/components/schemas/user_defined_view_column_resizing'
        sort_by:
          items:
            $ref: '#/components/schemas/user_defined_view_sort_by'
          type: array
        column_order:
          items:
            type: string
          type: array
      title: UserDefinedView
      type: object
    personal-identifier-type:
      enum:
      - CPR
      - CVR
      - CHR
      title: PersonalIdentifierType
      type: string
    personal-data:
      example:
        data: data
      properties:
        data:
          type: string
      required:
      - data
      title: PersonalData
      type: object
    single-upload-request:
      properties:
        metadata:
          $ref: '#/components/schemas/base-metadata'
        file:
          format: binary
          type: string
      required:
      - file
      - metadata
      title: SingleUploadRequest
      type: object
    upload-response:
      example:
        errors:
        - errors
        - errors
      properties:
        errors:
          items:
            type: string
          type: array
      title: UploadResponse
      type: object
    multi-upload-request:
      properties:
        metadata_tsv:
          format: binary
          type: string
        files:
          items:
            format: binary
            type: string
          type: array
      required:
      - files
      - metadata_tsv
      title: MultiUploadRequest
      type: object
    bulk-upload-request:
      properties:
        path:
          type: string
        metadata_tsv:
          format: binary
          type: string
      required:
      - metadata_tsv
      - path
      title: BulkUploadRequest
      type: object
    data-clearance:
      enum:
      - own-institution
      - cross-institution
      - all
      title: DataClearance
      type: string
    organization:
      enum:
      - SSI
      - FVST
      - Other
      title: Organization
      type: string
    permission:
      enum:
      - search
      - export
      - approve
      - phylogeny.read
      - phylogeny.write
      - gdpr.manage
      - permissions.write
      title: Permission
      type: string
    analysis-result:
      allOf:
      - $ref: '#/components/schemas/base-metadata'
      - $ref: '#/components/schemas/lims-specific-metadata'
      - $ref: '#/components/schemas/tbr-specific-metadata'
      - $ref: '#/components/schemas/analysis_result_allOf'
      title: AnalysisResult
      type: object
    tbr-metadata:
      allOf:
      - $ref: '#/components/schemas/base-metadata'
      - $ref: '#/components/schemas/tbr-specific-metadata'
      title: TbrMetadata
      type: object
    lims-metadata:
      allOf:
      - $ref: '#/components/schemas/base-metadata'
      - $ref: '#/components/schemas/lims-specific-metadata'
      title: LimsMetadata
      type: object
    approval-status:
      enum:
      - pending
      - rejected
      - approved
      title: ApprovalStatus
      type: string
    base-metadata:
      properties:
        isolate_id:
          type: string
        sequence_id:
          type: string
        sequence_filename:
          type: string
        institution:
          $ref: '#/components/schemas/organization'
        project_number:
          type: number
        project_title:
          type: string
        sampling_date:
          format: date-time
          type: string
        received_date:
          format: date-time
          type: string
        run_id:
          type: string
        public:
          type: string
        provided_species:
          type: string
        primary_isolate:
          type: boolean
      required:
      - institution
      - isolate_id
      - primary_isolate
      - provided_species
      - received_date
      - run_id
      - sequence_filename
      - sequence_id
      title: BaseMetadata
      type: object
    lims-specific-metadata:
      properties:
        chr_number:
          type: string
        cvr_number:
          type: string
        aut_number:
          type: string
        product_type:
          type: string
        product:
          type: string
        origin_country:
          type: string
          x-faker: address.country
        animal_species:
          type: string
        sample_info:
          type: string
      title: LimsSpecificMetadata
      type: object
    tbr-specific-metadata:
      properties:
        cpr_nr:
          type: string
        gender:
          enum:
          - M
          - K
          type: string
        name:
          type: string
          x-faker: name.findName
        age:
          maximum: 128
          minimum: 0
          type: integer
        travel:
          type: string
        travel_country:
          type: string
          x-faker: address.country
        run_date:
          format: date-time
          type: string
        kma_received_date:
          format: date-time
          type: string
        kma:
          type: string
        region:
          type: string
        fud_number:
          type: string
        cluster_id:
          type: string
        epi_export:
          type: string
      required:
      - run_date
      title: TbrSpecificMetadata
      type: object
    resistance:
      enum:
      - Sensitiv
      - Resistent
      - Ukendt
      title: Resistance
      type: string
    approval_allOf:
      properties:
        id:
          type: string
        approver:
          type: string
        timestamp:
          format: date-time
          type: string
        status:
          enum:
          - pending
          - cancelled
          - submitted
          type: string
    user_defined_view_column_resizing:
      example:
        column_width: 0
        column_widths:
          key: '{}'
      properties:
        column_widths:
          additionalProperties: true
          type: object
        column_width:
          type: integer
    user_defined_view_sort_by:
      example:
        id: id
        desc: true
      properties:
        desc:
          type: boolean
        id:
          type: string
    analysis_result_allOf:
      properties:
        _id:
          format: uuid
          type: string
        resfinder_version:
          type: string
        qc_provided_species:
          type: number
        qc_genome1x:
          type: number
        qc_genome10x:
          type: number
        qc_gsize_diff1x10:
          type: number
        qc_avg_coverage:
          type: number
        qc_final:
          enum:
          - A
          - B
          - C
          type: string
        subspecies:
          type: string
        species_final:
          type: string
        st:
          type: string
        pathotype:
          type: string
        pathotype_final:
          type: string
        serotype:
          type: string
        serotype_final:
          type: string
        adhesion:
          type: string
        adhesion_final:
          type: string
        toxins:
          type: string
        toxins_final:
          type: string
        infection_source:
          type: string
        resistance_genes:
          type: string
        amr_profile:
          type: string
        amr_ami:
          $ref: '#/components/schemas/resistance'
        amr_amp:
          $ref: '#/components/schemas/resistance'
        amr_azi:
          $ref: '#/components/schemas/resistance'
        amr_fep:
          $ref: '#/components/schemas/resistance'
        amr_fot:
          $ref: '#/components/schemas/resistance'
        amr_f_c:
          $ref: '#/components/schemas/resistance'
        amr_fox:
          $ref: '#/components/schemas/resistance'
        amr_taz:
          $ref: '#/components/schemas/resistance'
        amr_t_c:
          $ref: '#/components/schemas/resistance'
        amr_chl:
          $ref: '#/components/schemas/resistance'
        amr_cip:
          $ref: '#/components/schemas/resistance'
        amr_cli:
          $ref: '#/components/schemas/resistance'
        amr_col:
          $ref: '#/components/schemas/resistance'
        amr_dap:
          $ref: '#/components/schemas/resistance'
        amr_etp:
          $ref: '#/components/schemas/resistance'
        amr_ery:
          $ref: '#/components/schemas/resistance'
        amr_fus:
          $ref: '#/components/schemas/resistance'
        amr_gen:
          $ref: '#/components/schemas/resistance'
        amr_imi:
          $ref: '#/components/schemas/resistance'
        amr_kan:
          $ref: '#/components/schemas/resistance'
        amr_lzd:
          $ref: '#/components/schemas/resistance'
        amr_mero:
          $ref: '#/components/schemas/resistance'
        amr_mup:
          $ref: '#/components/schemas/resistance'
        amr_nal:
          $ref: '#/components/schemas/resistance'
        amr_pen:
          $ref: '#/components/schemas/resistance'
        amr_syn:
          $ref: '#/components/schemas/resistance'
        amr_rif:
          $ref: '#/components/schemas/resistance'
        amr_str:
          $ref: '#/components/schemas/resistance'
        amr_sul:
          $ref: '#/components/schemas/resistance'
        amr_tei:
          $ref: '#/components/schemas/resistance'
        amr_trm:
          $ref: '#/components/schemas/resistance'
        amr_tet:
          $ref: '#/components/schemas/resistance'
        amr_tia:
          $ref: '#/components/schemas/resistance'
        amr_tgc:
          $ref: '#/components/schemas/resistance'
        amr_tmp:
          $ref: '#/components/schemas/resistance'
        amr_van:
          $ref: '#/components/schemas/resistance'
      required:
      - _id
      - isolate_id
  securitySchemes:
    jwt:
      bearerFormat: JWT
      scheme: bearer
      type: http
      x-bearerInfoFunc: web.src.SAP.generated.controllers.security_controller_.info_from_jwt
